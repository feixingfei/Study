2100500018 ,2100066600-02 ,2100094668-01 ,2100308283 ,2100015381-01 ,
2100418373 ,2100017045-01 ,2100374205 ,2100393111 ,2100085641-13 ,2100025494-01 ,
2100271487-01 ,2100384149 ,2000186712 ,2100496671 ,2100343184 ,2100225047-01 ,
2100494391 ,2100492842 ,2100346112 ,2100521580-01 ,2100313597 ,2100361226 ,
2100371606 ,2100290928-04 ,2100021307-02 ,2100499387-01 ,2100328589-04 ,
2100348901-06 ,2100357811-01 ,2100395759-01 ,2100132903-03 ,2100519044-01 ,
2100346952-07 ,2000012557 ,2100399499-01 ,2100379166-02 ,2100250826-01 ,2100587050 ,
2100583100 ,2100144010-02 ,2100065372-03 ,2100627160 ,2100064946-04 ,2100237707-02 ,
2100453783-01 ,2100502129 ,2000111108 ,2100298817-02 ,2100475681 ,2100490302 ,
2100492182 ,2100065658-03 ,2100584730 ,2100124465-02 ,2100088526-02 ,2100129086-02 ,
2100066271-04 ,2100630930 ,2100640937 ,2100649580 ,2100653130-01 ,2000353722 ,
2000482737 ,2000363997 ,2000255972 ,2100502129 ,2000508138 ,2100500018 ,2100494846 ,
2100588210 ,2100493170 ,2100504669 ,2000365286 ,2300001532 ,2300002164 ,2000208026 ,
2000211943 ,2000213885 ,2000215236 ,2000227656 ,2000229794 ,2000255552 ,2000261247 ,
2000273523 ,2000295967 ,2000297050 ,2000325988 ,2000330989 ,2000338921 ,2000364118 ,
2000371855 ,2000379244 ,2000407743 ,2000423087 ,2000436084 ,2000457814 ,2100672402 ,
2100568190-01 ,2100514469 ,2100536661-01 ,2100517844 ,2100357017-01 ,2100493223 ,
2100123575-01 ,2000518965 ,2000439521 ,2100491247


"2100500018" ,"2100066600-02" ,"2100094668-01" ,"2100308283" ,"2100015381-01" ,
"2100418373" ,"2100017045-01" ,"2100374205" ,"2100393111" ,"2100085641-13" ,
"2100025494-01" ,"2100271487-01" ,"2100384149" ,"2000186712" ,"2100496671" ,
"2100343184" ,"2100225047-01" ,"2100494391" ,"2100492842" ,"2100346112" ,"2100521580-01" ,
"2100313597" ,"2100361226" ,"2100371606" ,"2100290928-04" ,"2100021307-02" ,
"2100499387-01" ,"2100328589-04" ,"2100348901-06" ,"2100357811-01" ,"2100395759-01" ,
"2100132903-03" ,"2100519044-01" ,"2100346952-07" ,"2000012557" ,"2100399499-01" ,
"2100379166-02" ,"2100250826-01" ,"2100587050" ,"2100583100" ,"2100144010-02" ,
"2100065372-03" ,"2100627160" ,"2100064946-04" ,"2100237707-02" ,"2100453783-01" ,
"2100502129" ,"2000111108" ,"2100298817-02" ,"2100475681" ,"2100490302" ,"2100492182" ,
"2100065658-03" ,"2100584730" ,"2100124465-02" ,"2100088526-02" ,"2100129086-02" ,
"2100066271-04" ,"2100630930" ,"2100640937" ,"2100649580" ,"2100653130-01" ,"2000353722" ,
"2000482737" ,"2000363997" ,"2000255972" ,"2100502129" ,"2000508138" ,"2100500018" ,
"2100494846" ,"2100588210" ,"2100493170" ,"2100504669" ,"2000365286" ,"2300001532" ,
"2300002164" ,"2000208026" ,"2000211943" ,"2000213885" ,"2000215236" ,"2000227656" ,
"2000229794" ,"2000255552" ,"2000261247" ,"2000273523" ,"2000295967" ,"2000297050" ,
"2000325988" ,"2000330989" ,"2000338921" ,"2000364118" ,"2000371855" ,"2000379244" ,
"2000407743" ,"2000423087" ,"2000436084" ,"2000457814" ,"2100672402" ,"2100568190-01" ,
"2100514469" ,"2100536661-01" ,"2100517844" ,"2100357017-01" ,"2100493223" ,"2100123575-01" ,
"2000518965" ,"2000439521" ,"2100491247"


-- backup data
# 1
drop table if exists tmp_topic_dmcommission_backup_sign;
# 2
create table tmp_topic_dmcommission_backup_sign as 
select * from topic_dmcommission;

-- patch data
# 1
DROP PROCEDURE IF EXISTS UpdateTopicDmCommission;

CREATE PROCEDURE watchmen_incometest_data_db.UpdateTopicDmCommission()
begin
	CREATE TEMPORARY TABLE IF NOT EXISTS tmp_update_keys (  
	    primarykey varchar(100) PRIMARY KEY
	);  

	-- 假设我们每次更新10条记录  
	SET @offset = 0;  
	SET @limit = 5000; 
	
	select count(*) into @totalCount from topic_dmcommission;

	while @offset < @totalCount do
		truncate table tmp_update_keys;
		
		PREPARE stmt FROM "
			INSERT INTO tmp_update_keys (primarykey)  
			SELECT c.primarykey FROM topic_dmcommission c order by c.primarykey limit ?,?
		";  
		EXECUTE stmt USING @offset, @limit; 
		DEALLOCATE PREPARE stmt;
	
		UPDATE topic_dmcommission c  
	    JOIN tmp_update_keys uk ON c.primarykey = uk.primarykey  
	    JOIN (  
		    select
				c.primarykey,
				c.commissiontype,
				(
					select case 
						when c.commissiontype = 'PC' then b.premiumbilloriginalfeeamount 
						else f.samecovergwp
					end
				) as dncnanp,
				f.amount as commissionamt
			from
				topic_dmcommission c
			join topic_fee f on
				c.primarykey = f.fee_id
			join topic_bill b on 
				c.commissionrefno = b.billrefno
		) amt ON c.primarykey = amt.primarykey  
		SET   
		    c.dncnanp = amt.dncnanp,  
		    c.commissionamt = amt.commissionamt,  
		    c.update_time_ = NOW();
	
	    SET @offset = @offset + @limit; 
	   
	   	commit;
	end while;
	  
	-- 删除临时表（如果需要）  
	DROP TEMPORARY TABLE IF EXISTS tmp_update_keys;
end

# 2
CALL UpdateTopicDmCommission();

-- roll back data
REPLACE INTO topic_dmcommission  
SELECT * FROM tmp_topic_dmcommission_backup_sign;
	
-- check data
select * from (
	select
		c.primarykey,
		c.policynum,
		c.commissiontype,
		(
			select case 
				when c.commissiontype = 'PC' then b.premiumbilloriginalfeeamount 
				else f.samecovergwp
			end
		) as dncnanp1,
		f.amount as commissionamt1,
		c.dncnanp,
		c.commissionamt
	from
		topic_dmcommission c
	join topic_fee f on
		c.primarykey = f.fee_id
	join topic_bill b on 
		c.commissionrefno = b.billrefno
) a where a.dncnanp1!=a.dncnanp;

