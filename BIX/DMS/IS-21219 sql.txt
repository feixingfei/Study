## General policy issued to overseas customer (i.e., GL posting will be generated with Segment 6).
select ma_no,details->'$.status',details->'$.ext.fundType' from ma where details->'$.maType'='FWG' and details->'$.ext.fundType'='OIF';

select
	distinct g.ma_no,g.product_code,g.dr_seg5
from
	gl_entry_split g
join trans_index t on
	g.fee_type = 'GWP'
	and g.dr_seg5 = '06'
	and g.ma_id = t.ma_id 
	and t.biz_type in ("NB","RN")
	and t.issue_date > '2023-01-01 00:00:00'
	and t.product_cate not in ('EB','AFFINITY');
# Group policy with multiple coverages (i.e., GL posting will be generated with multiple Cost Centres).
# "2100493223"
select
	distinct g.ma_no,t.product_cate,g.product_code,g.coverage_code,g.dr_seg3
from
	gl_entry_split g
join trans_index t on
	g.fee_type = 'GWP'
	and g.ma_id = t.ma_id
	and t.biz_type in ("NB","RN")
	and t.product_cate in ('EB','AFFINITY')
	and exists (select '1' from ma m where g.ma_id=m.ma_id and m.created_at > '2023-01-01 00:00:00')
	and exists (select '1' from gl_entry_split g2 where g.fee_type=g2.fee_type and g.ma_no=g2.ma_no and g.dr_seg3!=g2.dr_seg3);
# General policy with multiple coverages (i.e., GL posting will be generated with multiple Cost Centres).

select
	distinct g.ma_no,t.product_cate,g.product_code,g.coverage_code,g.dr_seg3
from
	gl_entry_split g
join trans_index t on
	g.fee_type = 'GWP'
	and g.ma_id = t.ma_id
	and t.biz_type in ("NB","RN")
	and t.issue_date > '2023-01-01 00:00:00'
	and t.product_cate not in ('EB','AFFINITY')
	and exists (select '1' from gl_entry_split g2 where g.fee_type=g2.fee_type and g.ma_no=g2.ma_no and g.dr_seg3!=g2.dr_seg3);

select
	distinct g.policy_no,t.product_cate,g.product_code,g.coverage_code,g.dr_seg3
from
	gl_entry_split g
join trans_index t on
	g.fee_type = 'GWP'
	and g.policy_id = t.policy_id
	and t.biz_type in ("NB","RN")
	and t.issue_date > '2023-01-01 00:00:00'
	and t.product_cate not in ('EB','AFFINITY')
	and t.ma_id is null
	and exists (select '1' from gl_entry_split g2 where g.fee_type=g2.fee_type and g.ma_no=g2.ma_no and g.dr_seg3!=g2.dr_seg3);

select ma_no,product_code,coverage_code,fee_type,dr_seg3,dr_seg5 from gl_entry_split where fee_type = 'GWP' and ma_no = "2000030877";


# IS-21174  2100491247
select ma_no,policy_no,fee_type,dr_seg5 from gl_entry_split where fee_type = 'BASIC_COMM' and dr_seg5 = '03';

# IS-21175 2000439521
select f1.ma_no,f1.policy_no,f1.fee_type,f1.biz_type,b.bill_ref_no from fee f1 join bill b on
	f1.fee_type = 'GWP'
	and exists (select '1' from fee f2 where f1.bill_id = f2.bill_id and f1.biz_type != f2.biz_type)
	and f1.bill_id = b.bill_id
order by f1.ma_no,f1.policy_no,f1.biz_type;
select ma_no,policy_no,fee_type,biz_type,bill_id from fee where ma_no = "" or policy_no = "2300002100";


# IS-20320
select 
	(
    	select case 
    		when gwpFee.ma_no is not null then gwpFee.ma_no 
    		else gwpFee.policy_no 
    	end
    ) as 'Policy Number',
    premBill.sc_code as 'Agent ID (T1)',
    premBill.bill_ref_no as 'Premium Reference Number',
    (
    	select case 
    		when gwpFee.declaration_id is not null then 'DECLARATION'
    		when gwpFee.endo_id is not null and gwpFee.life_policy_renewal_id is null and e.endo_details->>"$.endoType"='CHANGE_OF_SCHEME' then 'CHANGEPLAN'
    		when gwpFee.endo_id is not null and gwpFee.life_policy_renewal_id is null then e.endo_details->>"$.endoType"
    		when gwpFee.biz_type = 'RN' then 'RB'
    		when gwpFee.biz_type = 'NB' and gwpfee.life_policy_renewal_id is not null and l.seq != 1 then 'RNPRE'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='MEMBER_MOVEMENT' and e.endo_details->>"$.subEndoType"='NEW_MEMBER' and gwpFee.life_policy_renewal_id is not null then 'ADDMEMBER'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='MEMBER_MOVEMENT' and e.endo_details->>"$.subEndoType"='DELETE_MEMBER' and gwpFee.life_policy_renewal_id is not null then 'DELETEMEMBER'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='EDIT_INSURED_DOB' and gwpFee.life_policy_renewal_id is not null then 'EDITDOB'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='CHANGE_SA' and gwpFee.life_policy_renewal_id is not null then 'CHANGESA'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='CHANGE_OF_SCHEME' and gwpFee.life_policy_renewal_id is not null then 'CHANGEPLAN'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='EDIT_PH_NFN' and gwpFee.life_policy_renewal_id is not null then 'PHNFN'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='POLICY_LAPSE' and gwpFee.life_policy_renewal_id is not null then 'POLICY_LAPSE'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='CHANGE_PAYMENT_FREQUENCY' and gwpFee.life_policy_renewal_id is not null then 'CHANGEFREQUENCY'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='MIDWAY_CANCEL' and gwpFee.life_policy_renewal_id is not null then 'MIDWAY_CANCEL'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='INCEPTION_CANCEL' and gwpFee.life_policy_renewal_id is not null then 'INCEPTION_CANCEL'
    		when gwpFee.endo_id is not null and e.endo_details->>"$.endoType"='EXPIRE_POLICY' and gwpFee.life_policy_renewal_id is not null then 'EXPIRE_POLICY'
    		else gwpFee.biz_type
    	end
    ) as 'Alteration Type',
    (select case
    	when gwpFee.product_cate = 'EB' or gwpFee.life_policy_renewal_id is not null then 'Group'
    	else 'General'
    end) as 'LOB',
    gwpFee.product_code as 'Product Code',
    (
    	select case 
    		when gwpFee.coverage_code is null and gwpFee.product_code = 'CAP' then 'MD'
    		when gwpFee.coverage_code is null and gwpFee.product_code = 'FWB' then 'FWB'
    		when gwpFee.coverage_code is null and gwpFee.product_code = 'CPL' then 'EVENT_LIABLITY'
    		when gwpFee.coverage_code is null and gwpFee.product_code = 'GPAS' then 'GPAS'
    		when gwpFee.coverage_code is null and gwpFee.product_code = 'GFW' then 'HSPT'
    		else gwpFee.coverage_code 
    	end
    ) as 'Coverage Code',
    DATE_FORMAT(prembill.due_date, '%Y-%m-%d') as 'Premium Due Date',
    (select case 
	    when gwpFee.endo_id is not null then (select DATE_FORMAT(STR_TO_DATE(e.endo_details ->> '$.newPolicy.proposalDate','%d/%m/%Y'), '%Y-%m-%d'))
		when gwpFee.declaration_no is not null
		      then (select DATE_FORMAT(STR_TO_DATE(ma.declaration_details ->> '$.completedAt','%d/%m/%Y'), '%Y-%m-%d') from ma_declaration ma where ma.declaration_id = gwpFee.declaration_id)
		else (select DATE_FORMAT(STR_TO_DATE(policy_details ->> '$.proposalDate', '%d/%m/%Y'),'%Y-%m-%d') from policy where policy.policy_id = gwpFee.policy_id)
	end) as 'Policy Submission Date',
	if(gwpFee.ma_id is not null, 
		(select ma.details->>'$.status' from ma where ma.ma_id = gwpFee.ma_id),
        (select policy_details->>'$.status' from policy where policy.policy_id = gwpFee.policy_id)) as 'Policy Status',
    'LUMPSUM' as 'Payment frequency',
    gwpFee.amount as 'Modal Premium Amount',
    (gwpFee.amount + ifnull((gstFee.amount),0)) as 'Appropriation Amount',
    if(gwpFee.endo_id is not null or gwpFee.declaration_no is not null, gwpFee.amount,0) as 'Endorsement ANP',
    commBill.bill_type as 'Commission Type',
    commBill.bill_ref_no as 'Commission Reference Number',
    (
    	SELECT round(abs(ifnull((commFee.amount),0))/abs(gwpFee.amount), 2) 
    ) as 'Commission Rate',
    (ifnull((commFee.amount),0)) as 'Commission Amount',
    commBill.commission_status as 'Commission Status',
    ' ' as 'Commission Rate Change Flag'
from fee commFee
left join endo e on
	commFee.endo_id = e.endo_id 
left join life_policy_renewal l on
	l.policy_renewal_id = commFee.life_policy_renewal_id 
left join fee gwpFee on
	coalesce(gwpFee.ma_no,'1')=coalesce(commFee.ma_no,'1') and coalesce(gwpFee.policy_no,'1')=coalesce(commFee.policy_no,'1')and coalesce(gwpFee.endo_no,'1')=coalesce(commFee.endo_no,'1')
	and gwpFee.biz_type = commFee.biz_type and gwpFee.product_code=commFee.product_code and coalesce(gwpFee.coverage_code,'1')=coalesce(commFee.coverage_code,'1')
	and coalesce(gwpFee.billing_schedule_id,'1')=coalesce(commFee.billing_schedule_id,'1')
	and coalesce(gwpFee.fee_details->>"$.billSeq",'1')=coalesce(commFee.fee_details->>"$.billSeq",'1')
	and gwpFee.fee_type = 'GWP' 
left join fee gstFee on 
	coalesce(gwpFee.ma_no,'1')=coalesce(gstFee.ma_no,'1') and coalesce(gwpFee.policy_no,'1')=coalesce(gstFee.policy_no,'1')and coalesce(gwpFee.endo_no,'1')=coalesce(gstFee.endo_no,'1')
	and gwpFee.biz_type = gstFee.biz_type and gwpFee.product_code=gstFee.product_code and coalesce(gwpFee.coverage_code,'1')=coalesce(gstFee.coverage_code,'1')
	and coalesce(gwpFee.billing_schedule_id,'1')=coalesce(gstFee.billing_schedule_id,'1')
	and coalesce(gwpFee.fee_details->>"$.billSeq",'1')=coalesce(gstFee.fee_details->>"$.billSeq",'1')
	and gstFee.fee_type='TURNOVER_TAX_ON_PREM'
left join bill commBill on 
	commBill.bill_id = commFee.bill_id
left join bill premBill on
	premBill.bill_id = gwpFee.bill_id
where commFee.fee_type in ('BASIC_COMM','OR_COMM')
	and (commFee.policy_no in ('2100021307-02', '2100064946-04', '2100065372-03', '2100065658-03',
                               '2100066271-04', '2100088526-02', '2100124465-02', '2100129086-02',
                               '2100144010-02', '2100237707-02', '2100271487-01', '2100290928-04',
                               '2100328589-04', '2100346952-07', '2100348901-06', '2100357811-01',
                               '2100379166-02', '2100395759-01', '2100399499-01', '2100453783-01',
                               '2100490302', '2100492182', '2100492842', '2100494391',
                               '2100496671', '2100499387-01', '2100519044-01', '2100521580-01',
                               '2100583100', '2100584730', '2100587050', '2100627160',
                               '2100630930', '2100640937', '2100649580', '2100653130-01',
                               '2000012557', '2000111108', '2000186712', '2100015381-01',
                               '2100017045-01', '2100025494-01', '2100066600-02', '2100085641-13',
                               '2100094668-01', '2100132903-03', '2100225047-01', '2100250826-01',
                               '2100298817-02', '2100308283', '2100313597', '2100343184',
                               '2100346112', '2100361226', '2100371606', '2100374205',
                               '2100384149', '2100393111', '2100418373', '2100475681','2100500018' ,
                               '2100502129' ,'2000508138' ,'2100494846' ,'2100588210' ,'2100493170' ,
                               '2100504669' ,'2000365286' ,'2000457814' ,'2000371855','2100036880') or
          commFee.ma_no in ('2100021307-02', '2100064946-04', '2100065372-03', '2100065658-03',
                               '2100066271-04', '2100088526-02', '2100124465-02', '2100129086-02',
                               '2100144010-02', '2100237707-02', '2100271487-01', '2100290928-04',
                               '2100328589-04', '2100346952-07', '2100348901-06', '2100357811-01',
                               '2100379166-02', '2100395759-01', '2100399499-01', '2100453783-01',
                               '2100490302', '2100492182', '2100492842', '2100494391',
                               '2100496671', '2100499387-01', '2100519044-01', '2100521580-01',
                               '2100583100', '2100584730', '2100587050', '2100627160',
                               '2100630930', '2100640937', '2100649580', '2100653130-01',
                               '2000012557', '2000111108', '2000186712', '2100015381-01',
                               '2100017045-01', '2100025494-01', '2100066600-02', '2100085641-13',
                               '2100094668-01', '2100132903-03', '2100225047-01', '2100250826-01',
                               '2100298817-02', '2100308283', '2100313597', '2100343184',
                               '2100346112', '2100361226', '2100371606', '2100374205',
                               '2100384149', '2100393111', '2100418373', '2100475681','2100500018' ,
                               '2100502129' ,'2000508138' ,'2100494846' ,'2100588210' ,'2100493170' ,
                               '2100504669' ,'2000365286' ,'2000457814' ,'2000371855','2100036942','2100036906') 
         );


select ma_no,policy_no,endo_no,biz_type,fee_type,fee_details->>"$.commissionType",amount,product_code,coverage_code,billing_schedule_id,fee_details->>"$.billSeq",bill_id from fee where ma_no ='2100036942';
select bill_id,ma_no,policy_no,endo_no,biz_type,bill_type,bill_details->>"$.commissionType",amount,bill_details->>"$.linkedBillIds[*]" from bill where ma_no = '2100036942';


SELECT   
	b.bill_type,
    b.bill_ref_no,  
    b.balance,
    b.status,
    b1.bill_type,  
    b1.bill_ref_no ,
    b1.commission_status,
    b2.bill_type 'OR Comm 2',  
    b2.bill_ref_no ,
    b2.commission_status,
    b3.bill_type 'OR Comm 3',  
    b3.bill_ref_no ,
    b3.commission_status
FROM
    bill b  
left JOIN bill b1 ON 
	b1.bill_id = b.bill_details->>'$.linkedBillIds[0]'
	and b1.bill_type = 'DIRECT_COMM'
left join bill b2 on
	b2.bill_id = b.bill_details->>'$.linkedBillIds[1]'
	and b2.bill_type = 'OR_COMM'
	and b2.bill_details->>'$.commissionType'='TIER_2_OR_COMM'
left join bill b3 on
	b3.bill_id = b.bill_details->>'$.linkedBillIds[2]'
	and b3.bill_type = 'OR_COMM'
	and b3.bill_details->>'$.commissionType'='TIER_3_OR_COMM'
WHERE
    b.bill_type = 'DIRECT_PREM' and b.bill_ref_no in (
    	"CN3000013024" ,"CN3000021287" ,"CN3000021312" ,"CN3000026319" ,
		"DN3000029799" ,"CN3000028831" ,"CN3000031477" ,"DN3000032363" ,
		"DN3000041760"
	);

   select cs.settle_date,bill.sc_code,bill_type,bill_ref_no,commission_status from bill, commission_settle cs  where bill.commission_settle_id =cs.settle_id and bill.commission_status ='PAID';


select cs.settle_date,b.sc_code,b.ma_no,b.policy_no,b.bill_type,b.bill_ref_no,b.commission_status from bill b 
left join commission_settle cs on
	b.commission_settle_id =cs.settle_id
where b.commission_status ='PAID' and b.sc_code in ('514729','525161','68108G')
